<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Praga</title>
    <link rel="icon" href="biohazard-sign.png" type="image/png">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --red: #ff1744; --blue: #00e5ff; --gold: #ffd700; --green: #00e676; --dark: #050505;
            --glass: rgba(10, 10, 10, 0.6); --border: rgba(255, 255, 255, 0.15);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
        body { font-family: 'Rajdhani', sans-serif; background: var(--dark); color: #FFF; overflow: hidden; height: 100vh; }

        /* --- PRESERVA√á√ÉO: SETUP & BACKGROUND --- */
        #bgOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: url('background.png') no-repeat center center; background-size: cover; opacity: 0.25; z-index: 1; pointer-events: none; transition: opacity 0.8s ease; }
        .screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 5000; display: none; flex-direction: column; align-items: center; justify-content: center; transition: 0.3s; background: transparent; }
        .screen.active { display: flex; }
        #startMenu { background: radial-gradient(circle at center, rgba(255, 23, 68, 0.15) 0%, rgba(0, 0, 0, 0.8) 100%); }
        #optiScreen { background: rgba(20, 0, 0, 0.95); text-align: center; padding: 40px; }
        .setup-card { width: 95%; max-width: 900px; max-height: 85vh; padding: 35px; text-align: center; display: none; margin: auto; overflow-y: auto; }
        .setup-card.active { display: block; animation: slideIn 0.4s ease; }
        @keyframes slideIn { from { opacity:0; transform: scale(0.98); } to { opacity:1; transform: scale(1); } }

        /* --- PRESERVA√á√ÉO: TOP HUD --- */
        .top-bar { position: fixed; top: 12px; left: 2%; width: 96%; height: 55px; z-index: 9000; display: grid; grid-template-columns: 120px 1fr 60px; align-items: center; padding: 0 20px; transition: 0.5s ease; border-radius: 12px; pointer-events: none; }
        .top-bar > * { pointer-events: auto; }
        .glass-bar { background: var(--glass); backdrop-filter: blur(10px); border: 1px solid var(--border); }
        .highlight-bar { background: #000; border: 1px solid var(--red); box-shadow: 0 5px 25px rgba(0,0,0,0.8); }
        @keyframes pulse-red { 0% { color: var(--red); transform: scale(1); } 50% { color: #fff; transform: scale(1.03); } 100% { color: var(--red); transform: scale(1); } }
        .news-label-pulse { color: var(--red); font-weight: 900; font-family: Orbitron; font-size: 0.85rem; letter-spacing: 2px; cursor: pointer; animation: pulse-red 2s infinite ease-in-out; text-align: left; }
        .sound-btn { background: none; border: none; cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center; color: #FFF; }
        .sound-btn svg { width: 24px; height: 24px; fill: currentColor; }
        .sound-btn:hover { color: var(--red); transform: scale(1.1); }

        /* --- PRESERVA√á√ÉO: BOT√ïES PADRONIZADOS --- */
        .btn-main { background: #FFF; color: #800000; border: none; padding: 14px 30px; font-size: 1.2rem; font-weight: 800; border-radius: 6px; cursor: pointer; transition: all 0.2s ease; margin: 10px; text-transform: uppercase; width: 280px; font-family: 'Rajdhani'; box-shadow: 0 4px 0 #CCC; }
        .btn-main:hover { background: var(--red); color: #FFF; transform: scale(1.08); box-shadow: 0 6px 20px rgba(255, 23, 68, 0.4); }
        .btn-main:disabled { opacity: 0.5; cursor: default; pointer-events: none; }

        /* --- HUD INFERIOR --- */
        .bottom-hud { position: fixed; bottom: 20px; left: 2%; width: 96%; height: 90px; z-index: 9000; display: flex; align-items: flex-end; justify-content: space-between; pointer-events: none; }
        .bottom-hud > * { pointer-events: auto; }
        .hud-panel { background: rgba(5, 5, 5, 0.95); border: 1px solid var(--border); padding: 12px 20px; border-radius: 12px; display: grid; backdrop-filter: blur(10px); min-width: 320px; box-shadow: 0 -10px 30px rgba(0,0,0,0.5); }
        .hud-panel.right-align { text-align: right; justify-items: end; }
        .hud-panel.right-align .stat-item { align-items: flex-end; }
        .stat-item { display: flex; flex-direction: column; }
        .stat-label { font-family: Orbitron; font-size: 0.65rem; color: #FFF; font-weight: 700; letter-spacing: 1px; margin-bottom: 2px; }
        .stat-value { font-weight: 700; font-size: 1.1rem; color: #FFF; }
        .stat-value.infected { color: var(--red); text-shadow: 0 0 10px rgba(255, 23, 68, 0.4); }
        .btn-world { min-width: 180px; width: auto; max-width: 300px; height: 50px; font-size: 1rem; letter-spacing: 2px; font-family: Orbitron; padding: 0 20px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- MAPA & SIMBOLOGIA T√ÅTICA --- */
        #mainGame { width: 100%; height: 100vh; display: none; position: relative; z-index: 10; }
        #map { width: 100%; height: 100vh; z-index: 1; background: #0b0e14; cursor: crosshair !important; }
        
        .hub-icon { background: none; border: none; display: flex; align-items: center; justify-content: center; transition: transform 0.2s; }
        .hub-icon svg { fill: #FFF; filter: drop-shadow(0 0 2px #000); width: 22px; height: 22px; opacity: 0.9; }
        .hub-icon:hover svg { fill: var(--red); transform: scale(1.2); opacity: 1; }

        @keyframes pulse-blip { 0% { transform: scale(0.5); opacity: 1; } 100% { transform: scale(2.5); opacity: 0; } }
        .bio-blip { background: #800000; border-radius: 50%; width: 15px; height: 15px; border: 2px solid var(--red); box-shadow: 0 0 15px var(--red); position: relative; }
        .bio-blip::after { content: ''; position: absolute; top: -2px; left: -2px; width: 15px; height: 15px; border-radius: 50%; border: 2px solid var(--red); animation: pulse-blip 1.5s infinite; }

        /* --- MODAIS --- */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; display: none; align-items: center; justify-content: center; }
        .modal-card { width: 600px; padding: 45px; position: relative; border: 1px solid var(--border); box-shadow: 0 0 100px #000; border-radius: 15px; background: #080808; }
        .btn-x { position: absolute; top: 20px; right: 25px; background: none; border: none; color: #777; font-size: 2.2rem; cursor: pointer; transition: 0.3s; }
        .btn-x:hover:not(:disabled) { color: #FFF; }
        .btn-x:disabled { opacity: 0.3; cursor: default; }
        .welcome-nav { display: flex; justify-content: center; align-items: center; gap: 20px; margin-top: 30px; }
        .btn-nav-arrow { background: none; border: 1px solid #444; color: #FFF; font-size: 1.5rem; cursor: pointer; width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .btn-nav-arrow:disabled { opacity: 0.2; }
        #wPageIndicator { text-align: center; margin-top: 15px; color: #888; font-size: 0.9rem; font-family: Orbitron; }

        /* Auxiliares */
        .grid-select { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; margin: 25px 0; }
        .opt-box { padding: 18px; border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; cursor: pointer; background: rgba(20, 20, 20, 0.7); transition: 0.2s; color: #DDD; text-align: center; }
        .opt-box:hover, .opt-box.selected { border-color: var(--red); background: rgba(255,23,68,0.3); color: #FFF; }
        .opt-box b { display: block; font-size: 1.1rem; margin-bottom: 2px; color: #FFF; }
        #nameIn { width: 100%; padding: 25px; background: rgba(10, 10, 10, 0.85); border: 2px solid #666; color: #FFF; text-align: center; font-size: 2.5rem; margin: 30px 0; font-family: Rajdhani; border-radius: 10px; }
        .news-marquee-container { overflow: hidden; position: relative; height: 30px; margin: 0 20px; display: flex; align-items: center; }
        #ticker { color: #FFF; font-weight: 700; font-size: 1rem; position: absolute; white-space: nowrap; right: -110%; width: fit-content; }
        .error-msg-box { color: var(--red); font-weight: 700; font-size: 1rem; margin: 10px 0; min-height: 24px; opacity: 0; transition: 0.3s; }
    </style>
</head>
<body>

    <audio id="bgMusic1" preload="auto"><source src="music_bg_1.mp3" type="audio/mpeg"></audio>
    <audio id="bgMusic2" preload="auto"><source src="music_bg_2.mp3" type="audio/mpeg"></audio>
    <div id="bgOverlay"></div>

    <div id="unifiedTopBar" class="top-bar glass-bar">
        <span id="newsTag" class="news-label-pulse" onclick="openNewsLog()">NOT√çCIAS</span>
        <div class="news-marquee-container"><div id="ticker"></div></div>
        <button class="sound-btn" onclick="toggleSoundManual()" id="soundBtnIcon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
        </button>
    </div>

    <div id="startMenu" class="screen active">
        <div class="bio-logo" style="font-family: Orbitron; font-size: 5.5rem; letter-spacing: 15px; text-shadow: 0 0 35px var(--red); margin-bottom: 55px;">PRAGA</div>
        <button class="btn-main" onclick="goToOptimization()">Iniciar</button>
        <button class="btn-main" style="background: #FFF; color: #800000;" onclick="openModal('tutorialModal')">Tutorial</button>
        <button class="btn-main" style="background: #FFF; color: #800000;" onclick="alert('Hist√≥rico indispon√≠vel')">Conquistas</button>
    </div>

    <div id="optiScreen" class="screen">
        <div style="font-size: 4.5rem; margin-bottom: 25px; color: var(--red);">üíª</div>
        <h2 style="font-family: Orbitron; color: var(--red); margin-bottom: 20px; letter-spacing: 3px; font-size: 2.2rem; font-weight: 900;">RECOMENDA√á√ÉO DE TELA</h2>
        <p style="font-size: 1.3rem; line-height: 1.6; color: #FFF; margin-bottom: 45px; max-width: 750px;">Para uma imers√£o t√°tica completa e visualiza√ß√£o precisa dos dados globais, recomendamos o uso de telas grandes como <b>notebooks, monitores ou tablets</b>.</p>
        <button class="btn-main" onclick="initSetup()">Ciente</button>
    </div>

    <div id="selectionFlow" class="screen">
        <button class="btn-x" style="position: fixed; top:80px; right:25px; z-index:100;" onclick="location.reload()">‚úï</button>
        <div id="setupType" class="glass setup-card active">
            <h2 style="color: var(--red); font-family: Orbitron; margin-bottom: 15px; font-size: 2.2rem;">SELECIONAR AGENTE</h2>
            <div class="grid-select">
                <div class="opt-box" onclick="setVar('type', 'Bact√©ria', this)"><b>ü¶† BACT√âRIA</b><small>Potencial vers√°til e ilimitado</small></div>
                <div class="opt-box" onclick="setVar('type', 'V√≠rus', this)"><b>üß¨ V√çRUS</b><small>Agente de muta√ß√£o r√°pida</small></div>
                <div class="opt-box" onclick="setVar('type', 'Fungo', this)"><b>üçÑ FUNGO</b><small>Esporos persistentes</small></div>
                <div class="opt-box" onclick="setVar('type', 'Parasita', this)"><b>üêõ PARASITA</b><small>Hospedeiro oculto</small></div>
                <div class="opt-box" onclick="setVar('type', 'Pr√≠on', this)"><b>üíé PR√çON</b><small>Complexo e sutil</small></div>
                <div class="opt-box" onclick="setVar('type', 'Nano-V√≠rus', this)"><b>ü§ñ NANO-V√çRUS</b><small>M√°quina fora de controle</small></div>
                <div class="opt-box" onclick="setVar('type', 'Bio-Arma', this)"><b>‚ò¢Ô∏è BIO-ARMA</b><small>Criado para matar</small></div>
            </div>
            <div id="errorType" class="error-msg-box"></div>
            <button class="btn-main" onclick="runNextStep(this, 'setupDiff', 'type', 'errorType', 'Voc√™ precisa selecionar um agente para avan√ßar')">Confirmar Agente</button>
        </div>
        <div id="setupDiff" class="glass setup-card">
            <h2 style="color: var(--gold); font-family: Orbitron; margin-bottom: 15px; font-size: 2.2rem;">N√çVEL DE RESPOSTA</h2>
            <div class="grid-select">
                <div class="opt-box" onclick="setVar('diff', 'Casual', this)"><b style="color: var(--green);">üü¢ CASUAL</b><small>Mundo descuidado.<br>M√©dicos de meio per√≠odo.</small></div>
                <div class="opt-box" onclick="setVar('diff', 'Normal', this)"><b style="color: var(--gold);">üü° NORMAL</b><small>Mundo reativo.<br>Higiene mediana.</small></div>
                <div class="opt-box" onclick="setVar('diff', 'Brutal', this)"><b style="color: var(--red);">üî¥ BRUTAL</b><small>Mundo em alerta.<br>Pesquisa agressiva.</small></div>
            </div>
            <div id="errorDiff" class="error-msg-box"></div>
            <button class="btn-main" onclick="runNextStep(this, 'setupName', 'diff', 'errorDiff', 'Voc√™ precisa selecionar um n√≠vel de resposta para avan√ßar')">Confirmar Resposta</button>
        </div>
        <div id="setupName" class="glass setup-card">
            <h2 style="color: var(--blue); font-family: Orbitron; font-size: 2.2rem;">NOMEIE SUA CRIA√á√ÉO</h2>
            <p style="color: #AAA; margin-bottom: 10px;">Identifique o agente do fim da humanidade.</p>
            <input type="text" id="nameIn" placeholder="NOME..." maxlength="18">
            <div id="errorName" class="error-msg-box"></div>
            <button class="btn-main" onclick="startGame()">INICIAR ANIQUILA√á√ÉO</button>
        </div>
    </div>

    <div id="mainGame">
        <div id="map"></div>
        <div class="bottom-hud">
            <div class="hud-panel" style="grid-template-columns: 1fr 1fr; gap: 10px 30px;">
                <div class="stat-item"><span class="stat-label">INFECTADOS</span><span class="stat-value infected" id="valInfected">0</span></div>
                <div class="stat-item"><span class="stat-label">CURADOS</span><span class="stat-value" style="color:var(--green)" id="valCured">0</span></div>
                <div class="stat-item"><span class="stat-label">MORTOS</span><span class="stat-value" id="valDead">0</span></div>
                <div class="stat-item"><span class="stat-label">VACINADOS</span><span class="stat-value" style="color:var(--blue)" id="valVax">0</span></div>
            </div>
            <div class="world-btn-container"><button class="btn-main btn-world" id="btnWorld" onclick="handleWorldClick()">MUNDO</button></div>
            <div class="hud-panel right-align" style="grid-template-columns: 1fr;">
                <div class="stat-item"><span class="stat-label">MUTAGENICIDADE (DNA)</span><span class="stat-value" style="color: var(--blue);" id="valDNA">0</span></div>
                <div class="stat-item" style="margin-top: 10px;"><span class="stat-label">N√çVEL DE AMEA√áA</span><span class="stat-value" id="valThreat">M√çNIMO</span></div>
            </div>
        </div>
    </div>

    <div id="welcomeGameModal" class="overlay" style="background: rgba(0,0,0,0.5);">
        <div class="glass modal-card" style="max-width: 500px; min-height: 480px; display: flex; flex-direction: column; justify-content: space-between;">
            <button class="btn-x" id="btnWClose" onclick="closeModal()" disabled>‚úï</button>
            <div id="welcomePages" style="flex-grow: 1;">
                <div class="w-page active">
                    <h2 style="color: var(--red); font-family: Orbitron; margin-bottom: 20px;">PROTOCOLO INICIADO</h2>
                    <p style="font-size: 1.1rem; line-height: 1.6; color: #EEE;">Bem-vindo(a) ao jogo <b>Praga</b>!<br><br>Voc√™ √© um(a) cientista descontente com a humanidade e decide p√¥r fim √† sua exist√™ncia. Para isso, dever√° espalhar seu agente pelo mundo inteiro, at√© eliminar todos os seres humanos da Terra. Sua mente brilhante ser√° capaz de ‚Äúconsertar‚Äù o estado atual do mundo?</p>
                </div>
                <div class="w-page" style="display: none;">
                    <h2 style="color: var(--red); font-family: Orbitron; margin-bottom: 20px;">OBJETIVO INICIAL</h2>
                    <p style="font-size: 1.1rem; line-height: 1.6; color: #EEE;">Toque no pa√≠s que seu agente infectar√° primeiro!<br><br>Ao selecionar um pa√≠s, voc√™ poder√° ver suas informa√ß√µes no mesmo bot√£o <b>"MUNDO"</b> na parte inferior da tela.</p>
                </div>
            </div>
            <div>
                <div class="welcome-nav">
                    <button class="btn-nav-arrow" id="btnWPrev" onclick="navWelcome(-1)" disabled>‚Üê</button>
                    <button class="btn-main" id="btnWOk" style="width: auto; padding: 10px 30px;" onclick="closeModal()" disabled>OK</button>
                    <button class="btn-nav-arrow" id="btnWNext" onclick="navWelcome(1)">‚Üí</button>
                </div>
                <div id="wPageIndicator">1/2</div>
            </div>
        </div>
    </div>

    <div id="tutorialModal" class="overlay"><div class="glass modal-card"><button class="btn-x" onclick="closeModal()">‚úï</button><h2 style="color: var(--blue); font-family: Orbitron; margin-bottom: 25px;">MANUAL T√ÅTICO</h2><div style="text-align: left; line-height: 1.8; color: #FFF; font-size: 1.15rem;"><p>‚Ä¢ <b>1. Inser√ß√£o:</b> Clique em um pa√≠s no mapa global para liberar o Agente Patog√™nico.</p><p>‚Ä¢ <b>2. Recurso Gen√©tico:</b> Acumule 1 ponto de Mutagenicidade a cada <b>100.000</b> novos infectados.</p><p>‚Ä¢ <b>3. Resposta Global:</b> A <b>Cura</b> foca nos infectados; a <b>Vacina</b> protege os saud√°veis.</p><p>‚Ä¢ <b>4. Adapta√ß√£o:</b> Evoluir a praga for√ßa cientistas a reiniciar pesquisas, <b>atrasando cura e vacina</b>.</p></div></div></div>
    <div id="newsLogModal" class="overlay"><div class="glass modal-card"><button class="btn-x" onclick="closeModal()">‚úï</button><h2 style="color: var(--blue); font-family: Orbitron; margin-bottom: 25px;">HIST√ìRICO DE MANCHETES</h2><div id="newsEntries" style="max-height: 400px; overflow-y: auto;"></div></div></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let game = { started: false, name: '', type: '', diff: '', active: false, newsLog: [], soundOn: true, infected: 0, dead: 0, cured: 0, vax: 0, dna: 0, popCap: 8200000000, selectedCountry: null };
        
        // --- BASE DE DADOS DE HUBS AMPLIADA (v56) ---
        const worldHubs = [
            { country: "Brasil", type: "airport", city: "Bras√≠lia", lat: -15.8697, lng: -47.9208 },
            { country: "Brasil", type: "port", city: "Salvador", lat: -12.9228, lng: -38.5122 },
            { country: "M√©xico", type: "airport", city: "Cidade do M√©xico", lat: 19.4326, lng: -99.1332 },
            { country: "M√©xico", type: "port", city: "Veracruz", lat: 19.1738, lng: -96.1342 },
            { country: "Canad√°", type: "airport", city: "Ottawa", lat: 45.4215, lng: -75.6972 },
            { country: "Canad√°", type: "port", city: "Vancouver", lat: 49.2827, lng: -123.1207 },
            { country: "Argentina", type: "airport", city: "Buenos Aires", lat: -34.6037, lng: -58.3816 },
            { country: "Argentina", type: "port", city: "Mar del Plata", lat: -38.0055, lng: -57.5426 },
            { country: "Peru", type: "airport", city: "Lima", lat: -12.0464, lng: -77.0428 },
            { country: "Peru", type: "port", city: "Callao", lat: -12.0566, lng: -77.1491 },
            { country: "Col√¥mbia", type: "airport", city: "Bogot√°", lat: 4.7110, lng: -74.0721 },
            { country: "Col√¥mbia", type: "port", city: "Cartagena", lat: 10.3910, lng: -75.4794 },
            { country: "√Åfrica do Sul", type: "airport", city: "Joanesburgo", lat: -26.1367, lng: 28.2411 },
            { country: "√Åfrica do Sul", type: "port", city: "Cidade do Cabo", lat: -33.9189, lng: 18.4233 },
            { country: "Marrocos", type: "airport", city: "Rabat", lat: 33.9716, lng: -6.8498 },
            { country: "Marrocos", type: "port", city: "Casablanca", lat: 33.5731, lng: -7.5898 },
            { country: "Egito", type: "airport", city: "Cairo", lat: 30.1219, lng: 31.4056 },
            { country: "Egito", type: "port", city: "Alexandria", lat: 31.2001, lng: 29.9187 },
            { country: "Espanha", type: "airport", city: "Madrid", lat: 40.4839, lng: -3.5680 },
            { country: "Espanha", type: "port", city: "Barcelona", lat: 41.3851, lng: 2.1734 },
            { country: "Fran√ßa", type: "airport", city: "Paris", lat: 49.0097, lng: 2.5479 },
            { country: "Fran√ßa", type: "port", city: "Marselha", lat: 43.2965, lng: 5.3698 },
            { country: "Ar√°bia Saudita", type: "airport", city: "Riad", lat: 24.9576, lng: 46.6988 },
            { country: "Ar√°bia Saudita", type: "port", city: "Jid√°", lat: 21.4858, lng: 39.1925 },
            { country: "√çndia", type: "airport", city: "Nova Deli", lat: 28.5562, lng: 77.1000 },
            { country: "√çndia", type: "port", city: "Bombaim", lat: 18.9220, lng: 72.8347 },
            { country: "Finl√¢ndia", type: "airport", city: "Hels√≠nquia", lat: 60.3172, lng: 24.9633 },
            { country: "Finl√¢ndia", type: "port", city: "Porto de Hels√≠nquia", lat: 60.1600, lng: 24.9600 },
            { country: "Jap√£o", type: "airport", city: "T√≥quio", lat: 35.5494, lng: 139.7798 },
            { country: "Jap√£o", type: "port", city: "Yokohama", lat: 35.4437, lng: 139.6380 },
            { country: "Austr√°lia", type: "airport", city: "Canberra", lat: -35.3050, lng: 149.1934 },
            { country: "Austr√°lia", type: "port", city: "Sydney", lat: -33.8688, lng: 151.2093 },
            { country: "Nova Zel√¢ndia", type: "airport", city: "Wellington", lat: -41.3276, lng: 174.8076 },
            { country: "Nova Zel√¢ndia", type: "port", city: "Auckland", lat: -36.8485, lng: 174.7633 },
            { country: "Turquia", type: "airport", city: "Ancara", lat: 40.1281, lng: 32.9951 },
            { country: "Turquia", type: "port", city: "Istambul", lat: 41.0082, lng: 28.9784 },
            { country: "Reino Unido", type: "airport", city: "Londres", lat: 51.4700, lng: -0.4543 },
            { country: "R√∫ssia", type: "airport", city: "Moscou", lat: 55.7558, lng: 37.6173 },
            { country: "EUA", type: "airport", city: "Washington", lat: 38.8512, lng: -77.0402 },
            { country: "Groenl√¢ndia", type: "port", city: "Nuuk", lat: 64.1750, lng: -51.7389 },
            { country: "Madagascar", type: "port", city: "Toamasina", lat: -18.1492, lng: 49.4023 },
            { country: "Su√≠√ßa", type: "airport", city: "Berna", lat: 46.9128, lng: 7.4984 }
        ];

        // --- SISTEMA DE √ÅUDIO ---
        const audioSystem = {
            tracks: [document.getElementById('bgMusic1'), document.getElementById('bgMusic2')],
            currentTrackIndex: 0, isMuted: false, fadeInterval: null,
            init() { this.tracks[0].volume = 0; this.tracks[1].volume = 0; this.tracks[0].addEventListener('ended', () => this.crossfadeTo(1)); this.tracks[1].addEventListener('ended', () => this.crossfadeTo(0)); },
            startPlayback() { if (this.isMuted) return; this.fadeIn(0); },
            crossfadeTo(nextIndex) { if (this.isMuted) return; const nextTrack = this.tracks[nextIndex]; const currentTrack = this.tracks[nextIndex === 0 ? 1 : 0]; nextTrack.play(); clearInterval(this.fadeInterval); let step = 0; const steps = 50; this.fadeInterval = setInterval(() => { step++; currentTrack.volume = Math.max(0, 1 - (step / steps)); nextTrack.volume = Math.min(1, step / steps); if (step >= steps) { clearInterval(this.fadeInterval); currentTrack.pause(); currentTrack.currentTime = 0; this.currentTrackIndex = nextIndex; } }, 100); },
            fadeIn(index) { const track = this.tracks[index]; track.play(); let vol = 0; const int = setInterval(() => { vol = Math.min(1, vol + 0.05); track.volume = vol; if (vol >= 1) clearInterval(int); }, 200); },
            toggleMute() { this.isMuted = !this.isMuted; clearInterval(this.fadeInterval); if (this.isMuted) { this.tracks.forEach(t => { t.volume = 0; t.pause(); }); } else { this.tracks[this.currentTrackIndex].volume = 1; this.tracks[this.currentTrackIndex].play(); } return this.isMuted; }
        };
        audioSystem.init();
        function toggleSoundManual() {
            const muted = audioSystem.toggleMute();
            document.getElementById('soundBtnIcon').innerHTML = muted ? 
                '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51c.66-1.24 1.03-2.65 1.03-4.15 0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/></svg>' :
                '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>';
        }
        
        let welcomePageIndex = 0; function navWelcome(dir) { const pages = document.querySelectorAll('.w-page'); const indicator = document.getElementById('wPageIndicator'); pages[welcomePageIndex].style.display = 'none'; welcomePageIndex += dir; pages[welcomePageIndex].style.display = 'block'; document.getElementById('btnWPrev').disabled = (welcomePageIndex === 0); document.getElementById('btnWNext').disabled = (welcomePageIndex === pages.length - 1); indicator.innerText = `${welcomePageIndex + 1}/${pages.length}`; if (welcomePageIndex === pages.length - 1) { document.getElementById('btnWClose').disabled = false; document.getElementById('btnWOk').disabled = false; } }

        const preGameNewsSource = ["\"Cansamos de salvar um futuro que insiste em se destruir.\"", "\"Quando o fato vira opini√£o, a ci√™ncia vira ru√≠na.\"", "\"O descr√©dito √© o √°cido que corr√≥i as funda√ß√µes do amanh√£.\"", "\"A ci√™ncia n√£o vai cair. Ela vai simplesmente se calar.\"", "\"Onde a cren√ßa vence a prova, o cientista se torna um fantasma.\"", "\"N√£o h√° como curar um mundo que ama a pr√≥pria ferida.\"", "\"O laborat√≥rio est√° vazio porque a verdade se tornou indesejada.\"", "\"A raz√£o se retirou da sala. O colapso agora √© livre.\"", "\"N√£o somos mais guias, somos apenas testemunhas da queda.\""];
        let newsQueue = []; let newsTimeout;
        function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } }
        function scheduleNextNews() { if (game.started) return; if (newsQueue.length === 0) { newsQueue = [...preGameNewsSource]; shuffleArray(newsQueue); }
            registerNews(newsQueue.pop()); const randomDelay = Math.floor(Math.random() * 10001) + 10000; newsTimeout = setTimeout(scheduleNextNews, 20000 + randomDelay);
        }
        window.onload = () => { registerNews("O descr√©dito √† ci√™ncia tem levado muitos cientistas a se manifestarem contra essa tend√™ncia. Ser√° que a ci√™ncia se revoltar√° em breve?"); setTimeout(scheduleNextNews, 22000); };
        function goToOptimization() { document.getElementById('startMenu').classList.remove('active'); document.getElementById('optiScreen').classList.add('active'); }
        function initSetup() { audioSystem.startPlayback(); document.getElementById('optiScreen').classList.remove('active'); document.getElementById('selectionFlow').classList.add('active'); }
        function openNewsLog() { game.active = false; document.getElementById('newsEntries').innerHTML = game.newsLog.map(e => `<div style="padding:10px; border-bottom:1px solid #333"><b style="color:var(--blue)">${e.date}</b>: ${e.message}</div>`).join(''); openModal('newsLogModal'); }
        function setVar(key, val, el) { game[key] = val; el.parentElement.querySelectorAll('.opt-box').forEach(i => i.classList.remove('selected')); el.classList.add('selected'); }
        function registerNews(text) { if (game.started) game.newsLog.unshift({ date: "20 jan. 2026", message: text }); const ticker = document.getElementById('ticker'); ticker.innerText = text.toUpperCase(); ticker.style.transition = 'none'; ticker.style.right = '-110%'; setTimeout(() => { ticker.style.transition = 'right 20s linear'; ticker.style.right = '125%'; }, 100); }
        function runNextStep(btn, id, currentKey, errorDivId, message) { const errorDiv = document.getElementById(errorDivId); if (!game[currentKey]) { errorDiv.innerText = message; errorDiv.style.opacity = '1'; setTimeout(() => errorDiv.style.opacity = '0', 3000); return; } btn.closest('.setup-card').classList.remove('active'); document.getElementById(id).classList.add('active'); }
        
        function startGame() { 
            const name = document.getElementById('nameIn').value.trim(); const errorDiv = document.getElementById('errorName'); 
            if (!name) { errorDiv.innerText = "Voc√™ precisa nomear sua cria√ß√£o para avan√ßar"; errorDiv.style.opacity = '1'; setTimeout(() => errorDiv.style.opacity = '0', 3000); return; } 
            game.name = name; game.started = true; clearTimeout(newsTimeout); document.getElementById('bgOverlay').style.opacity = '0'; document.getElementById('selectionFlow').classList.remove('active'); 
            document.getElementById('mainGame').style.display = 'block'; document.getElementById('unifiedTopBar').classList.replace('glass-bar', 'highlight-bar'); 
            const vMap = { 'Bact√©ria': 'BACTERIANO', 'V√≠rus': 'VIRAL', 'Fungo': 'F√öNGICO', 'Parasita': 'PARASIT√ÅRIO', 'Pr√≠on': 'PRI√îNICO', 'Nano-V√≠rus': 'NANOTECNOL√ìGICO', 'Bio-Arma': 'BIOL√ìGICO' }; 
            registerNews(`SISTEMA DE ANIQUILA√á√ÉO BIO-T√ÅTICA ONLINE. VETOR ${vMap[game.type]} PRONTO. AGUARDANDO DISPERS√ÉO.`); 
            setTimeout(() => { if(!map) initMap(); map.invalidateSize(); openModal('welcomeGameModal'); }, 100); 
        }

        let map; let blipMarker; 
        const hubLayer = L.layerGroup();

        function initMap() { 
            map = L.map('map', { center: [20, 0], zoom: 2.5, minZoom: 2.5, zoomControl: false, attributionControl: false, worldCopyJump: true }); 
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { noWrap: false }).addTo(map); 
            hubLayer.addTo(map);
            map.on('zoomend', () => { if (map.getZoom() < 3) map.removeLayer(hubLayer); else hubLayer.addTo(map); });
            renderHubs();
            map.on('click', async (e) => { updateCountrySelection(e.latlng); });
        }

        async function updateCountrySelection(latlng) {
            const url = `https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${latlng.lat}&longitude=${latlng.lng}&localityLanguage=pt`;
            const res = await fetch(url); const data = await res.json(); const btn = document.getElementById('btnWorld');
            if (data.countryName) {
                game.selectedCountry = data.countryName; btn.innerText = data.countryName.toUpperCase();
                if (blipMarker) map.removeLayer(blipMarker); const blipIcon = L.divIcon({ className: 'bio-blip', iconSize: [15, 15] }); blipMarker = L.marker(latlng, { icon: blipIcon }).addTo(map);
            } else {
                game.selectedCountry = null; btn.innerText = "MUNDO"; if (blipMarker) map.removeLayer(blipMarker);
            }
        }

        // ‚úÖ RENDERIZA√á√ÉO DE HUBS ATUALIZADA (v56 - S√≠mbolo de √Çncora Corrigido)
        function renderHubs() {
            const icons = {
                airport: '<svg viewBox="0 0 24 24"><path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L14 19v-5.5l8 2.5z"/></svg>',
                // S√≠mbolo de √¢ncora s√≥lido e robusto
                port: '<svg viewBox="0 0 24 24"><path d="M12 2a3 3 0 1 0 0 6 3 3 0 0 0 0-6zm0 2a1 1 0 1 1 0 2 1 1 0 0 1 0-2zm0 6a1 1 0 0 1 1 1v6.17c3.15-.36 5.59-2.88 5.95-6H17a1 1 0 0 1 0-2h4a1 1 0 0 1 1 1 9.02 9.02 0 0 1-8 8.95V20h3a1 1 0 0 1 0 2h-8a1 1 0 0 1 0-2h3v-2.88a9.02 9.02 0 0 1-8-8.95 1 1 0 0 1 1-1h4a1 1 0 0 1 0 2h-1.95c.36 3.12 2.8 5.64 5.95 6V11a1 1 0 0 1 1-1z"/></svg>'
            };
            worldHubs.forEach(hub => {
                const icon = L.divIcon({ className: 'hub-icon', html: icons[hub.type], iconSize: [24, 24] });
                const marker = L.marker([hub.lat, hub.lng], { icon: icon }).addTo(hubLayer);
                marker.on('click', (e) => { L.DomEvent.stopPropagation(e); updateCountrySelection({lat: hub.lat, lng: hub.lng}); });
            });
        }

        function handleWorldClick() { if (game.selectedCountry) alert(`Relat√≥rio t√°tico de ${game.selectedCountry} em processamento...`); else alert('Estat√≠sticas globais em desenvolvimento.'); }
        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal() { document.querySelectorAll('.overlay').forEach(o => o.style.display = 'none'); if(game.started) game.active = true; }
    </script>
</body>
</html>