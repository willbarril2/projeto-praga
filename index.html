<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Praga</title>
  <link rel="icon" href="biohazard-sign.png" type="image/png">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --red: #ff1744; --blue: #00e5ff; --gold: #ffd700; --green: #00e676; --dark: #050505;
      --glass: rgba(10, 10, 10, 0.6); --border: rgba(255, 255, 255, 0.15);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
    body { font-family: 'Rajdhani', sans-serif; background: var(--dark); color: #FFF; overflow: hidden; height: 100vh; }

    /* --- PRESERVA√á√ÉO: SETUP & BACKGROUND --- */
    #bgOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: url('background.png') no-repeat center center; background-size: cover; opacity: 0.25; z-index: 1; pointer-events: none; transition: opacity 0.8s ease; }
    .screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 5000; display: none; flex-direction: column; align-items: center; justify-content: center; transition: 0.3s; background: transparent; }
    .screen.active { display: flex; }
    #startMenu { background: radial-gradient(circle at center, rgba(255, 23, 68, 0.15) 0%, rgba(0, 0, 0, 0.8) 100%); }
    #optiScreen { background: rgba(20, 0, 0, 0.95); text-align: center; padding: 40px; }
    .setup-card { width: 95%; max-width: 900px; max-height: 85vh; padding: 35px; text-align: center; display: none; margin: auto; overflow-y: auto; }
    .setup-card.active { display: block; animation: slideIn 0.4s ease; }
    @keyframes slideIn { from { opacity:0; transform: scale(0.98); } to { opacity:1; transform: scale(1); } }

    /* --- PRESERVA√á√ÉO: TOP HUD --- */
    .top-bar { position: fixed; top: 12px; left: 2%; width: 96%; height: 55px; z-index: 9000; display: grid; grid-template-columns: 120px 1fr 60px; align-items: center; padding: 0 20px; transition: 0.5s ease; border-radius: 12px; pointer-events: none; }
    .top-bar > * { pointer-events: auto; }
    .glass-bar { background: var(--glass); backdrop-filter: blur(10px); border: 1px solid var(--border); }
    .highlight-bar { background: #000; border: 1px solid var(--red); box-shadow: 0 5px 25px rgba(0,0,0,0.8); }
    @keyframes pulse-red { 0% { color: var(--red); transform: scale(1); } 50% { color: #fff; transform: scale(1.03); } 100% { color: var(--red); transform: scale(1); } }
    .news-label-pulse { color: var(--red); font-weight: 900; font-family: Orbitron; font-size: 0.85rem; letter-spacing: 2px; cursor: pointer; animation: pulse-red 2s infinite ease-in-out; text-align: left; }
    .sound-btn { background: none; border: none; cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center; color: #FFF; }
    .sound-btn svg { width: 24px; height: 24px; fill: currentColor; }
    .sound-btn:hover { color: var(--red); transform: scale(1.1); }

    /* --- PRESERVA√á√ÉO: BOT√ïES PADRONIZADOS --- */
    .btn-main { background: #FFF; color: #800000; border: none; padding: 14px 30px; font-size: 1.2rem; font-weight: 800; border-radius: 6px; cursor: pointer; transition: all 0.2s ease; margin: 10px; text-transform: uppercase; width: 280px; font-family: 'Rajdhani'; box-shadow: 0 4px 0 #CCC; }
    .btn-main:hover { background: var(--red); color: #FFF; transform: scale(1.08); box-shadow: 0 6px 20px rgba(255, 23, 68, 0.4); }
    .btn-main:disabled { opacity: 0.5; cursor: default; pointer-events: none; }

    /* --- HUD INFERIOR --- */
    .bottom-hud { position: fixed; bottom: 20px; left: 2%; width: 96%; height: 90px; z-index: 9000; display: flex; align-items: flex-end; justify-content: space-between; pointer-events: none; }
    .bottom-hud > * { pointer-events: auto; }
    .hud-panel { background: rgba(5, 5, 5, 0.95); border: 1px solid var(--border); padding: 12px 20px; border-radius: 12px; display: grid; backdrop-filter: blur(10px); min-width: 320px; box-shadow: 0 -10px 30px rgba(0,0,0,0.5); }
    .hud-panel.right-align { text-align: right; justify-items: end; }
    .hud-panel.right-align .stat-item { align-items: flex-end; }
    .stat-item { display: flex; flex-direction: column; }
    .stat-label { font-family: Orbitron; font-size: 0.65rem; color: #FFF; font-weight: 700; letter-spacing: 1px; margin-bottom: 2px; }
    .stat-value { font-weight: 700; font-size: 1.1rem; color: #FFF; }
    .stat-value.infected { color: var(--red); text-shadow: 0 0 10px rgba(255, 23, 68, 0.4); }
    .btn-world { min-width: 180px; width: auto; max-width: 300px; height: 50px; font-size: 1rem; letter-spacing: 2px; font-family: Orbitron; padding: 0 20px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* --- MAPA & SIMBOLOGIA T√ÅTICA --- */
    #mainGame { width: 100%; height: 100vh; display: none; position: relative; z-index: 10; }
    #map { width: 100%; height: 100vh; z-index: 1; background: #0b0e14; cursor: crosshair !important; }
    .hub-icon-img { filter: brightness(0) invert(1); transition: transform 0.2s, filter 0.2s; pointer-events: auto; }
    .hub-icon-img:hover { transform: scale(1.3); filter: brightness(0) invert(1) drop-shadow(0 0 5px var(--red)); }

    @keyframes pulse-blip { 0% { transform: scale(0.5); opacity: 1; } 100% { transform: scale(2.5); opacity: 0; } }
    .bio-blip { background: #800000; border-radius: 50%; width: 15px; height: 15px; border: 2px solid var(--red); box-shadow: 0 0 15px var(--red); position: relative; }
    .bio-blip::after { content: ''; position: absolute; top: -2px; left: -2px; width: 15px; height: 15px; border-radius: 50%; border: 2px solid var(--red); animation: pulse-blip 1.5s infinite; }

    .leaflet-popup-content-wrapper { background: rgba(5, 5, 5, 0.98) !important; color: #FFF !important; border: 1px solid var(--border) !important; border-radius: 8px !important; box-shadow: 0 10px 40px #000 !important; padding: 5px; }
    .leaflet-popup-tip { background: rgba(5, 5, 5, 0.98) !important; border: 1px solid var(--border) !important; }
    .dispersal-box { text-align: center; padding: 10px; min-width: 220px; }
    .dispersal-box p { font-size: 0.95rem; margin-bottom: 15px; line-height: 1.4; font-family: 'Rajdhani'; font-weight: 600; }
    .dispersal-actions { display: flex; justify-content: center; gap: 10px; }
    .btn-mini { background: #FFF; color: #800000; border: none; padding: 6px 20px; font-size: 0.9rem; font-weight: 800; border-radius: 4px; cursor: pointer; transition: 0.2s; font-family: 'Orbitron'; text-transform: uppercase; }
    .btn-mini:hover { background: var(--red); color: #FFF; transform: translateY(-2px); }

    /* --- MODAIS --- */
    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; display: none; align-items: center; justify-content: center; }
    .modal-card { width: 600px; padding: 45px; position: relative; border: 1px solid var(--border); box-shadow: 0 0 100px #000; border-radius: 15px; background: #080808; }
    .btn-x { position: absolute; top: 20px; right: 25px; background: none; border: none; color: #777; font-size: 2.2rem; cursor: pointer; transition: 0.3s; }
    .btn-x:hover:not(:disabled) { color: #FFF; }
    .btn-x:disabled { opacity: 0.3; cursor: default; }

    .welcome-nav { display: flex; justify-content: center; align-items: center; gap: 20px; margin-top: 30px; }
    .btn-nav-arrow { background: none; border: 1px solid #444; color: #FFF; font-size: 1.5rem; cursor: pointer; width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
    .btn-nav-arrow:disabled { opacity: 0.2; }
    #wPageIndicator { text-align: center; margin-top: 15px; color: #888; font-size: 0.9rem; font-family: Orbitron; }

    .grid-select { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; margin: 25px 0; }
    .opt-box { padding: 18px; border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; cursor: pointer; background: rgba(20, 20, 20, 0.7); transition: 0.2s; color: #DDD; text-align: center; }
    .opt-box:hover, .opt-box.selected { border-color: var(--red); background: rgba(255,23,68,0.3); color: #FFF; }
    .opt-box b { display: block; font-size: 1.1rem; margin-bottom: 5px; color: #FFF; }

    #nameIn { width: 100%; padding: 25px; background: rgba(10, 10, 10, 0.85); border: 2px solid #666; color: #FFF; text-align: center; font-size: 2.5rem; margin: 30px 0; font-family: Rajdhani; border-radius: 10px; }
    .news-marquee-container { overflow: hidden; position: relative; height: 30px; margin: 0 20px; display: flex; align-items: center; }
    #ticker { color: #FFF; font-weight: 700; font-size: 1rem; position: absolute; white-space: nowrap; right: -110%; width: fit-content; }
    .error-msg-box { color: var(--red); font-weight: 700; font-size: 1rem; margin: 10px 0; min-height: 24px; opacity: 0; transition: 0.3s; }
  </style>
</head>

<body>
  <audio id="bgMusic1" preload="auto"><source src="music_bg_1.mp3" type="audio/mpeg"></audio>
  <audio id="bgMusic2" preload="auto"><source src="music_bg_2.mp3" type="audio/mpeg"></audio>

  <div id="bgOverlay"></div>

  <div id="unifiedTopBar" class="top-bar glass-bar">
    <span id="newsTag" class="news-label-pulse" onclick="openNewsLog()">NOT√çCIAS</span>
    <div class="news-marquee-container"><div id="ticker"></div></div>
    <button class="sound-btn" onclick="toggleSoundManual()" id="soundBtnIcon">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51c.66-1.24 1.03-2.65 1.03-4.15 0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/></svg>
    </button>
  </div>

  <div id="startMenu" class="screen active">
    <div class="bio-logo" style="font-family: Orbitron; font-size: 5.5rem; letter-spacing: 15px; text-shadow: 0 0 35px var(--red); margin-bottom: 55px;">PRAGA</div>
    <button class="btn-main" onclick="goToOptimization()">Iniciar</button>
    <button class="btn-main" style="background: #FFF; color: #800000;" onclick="openModal('tutorialModal')">Tutorial</button>
    <button class="btn-main" style="background: #FFF; color: #800000;" onclick="alert('Hist√≥rico indispon√≠vel')">Conquistas</button>
  </div>

  <div id="optiScreen" class="screen">
    <div style="font-size: 4.5rem; margin-bottom: 25px; color: var(--red);">üíª</div>
    <h2 style="font-family: Orbitron; color: var(--red); margin-bottom: 20px; letter-spacing: 3px; font-size: 2.2rem; font-weight: 900;">RECOMENDA√á√ÉO DE TELA</h2>
    <p style="font-size: 1.3rem; line-height: 1.6; color: #FFF; margin-bottom: 45px; max-width: 750px;">Para uma imers√£o t√°tica completa e visualiza√ß√£o precisa dos dados globais, recomendamos o uso de telas grandes como <b>notebooks, monitores ou tablets</b>.</p>
    <button class="btn-main" onclick="initSetup()">Ciente</button>
  </div>

  <div id="selectionFlow" class="screen">
    <button class="btn-x" style="position: fixed; top:80px; right:25px; z-index:100;" onclick="location.reload()">‚úï</button>

    <div id="setupType" class="glass setup-card active">
      <h2 style="color: var(--red); font-family: Orbitron; margin-bottom: 15px; font-size: 2.2rem;">SELECIONAR AGENTE</h2>
      <div class="grid-select">
        <div class="opt-box" onclick="setVar('type', 'Bact√©ria', this)"><b>ü¶† BACT√âRIA</b><small>Potencial vers√°til e ilimitado</small></div>
        <div class="opt-box" onclick="setVar('type', 'V√≠rus', this)"><b>üß¨ V√çRUS</b><small>Agente de muta√ß√£o r√°pida</small></div>
        <div class="opt-box" onclick="setVar('type', 'Fungo', this)"><b>üçÑ FUNGO</b><small>Esporos persistentes</small></div>
        <div class="opt-box" onclick="setVar('type', 'Parasita', this)"><b>üêõ PARASITA</b><small>Hospedeiro oculto</small></div>
        <div class="opt-box" onclick="setVar('type', 'Pr√≠on', this)"><b>üíé PR√çON</b><small>Complexo e sutil</small></div>
        <div class="opt-box" onclick="setVar('type', 'Nano-V√≠rus', this)"><b>ü§ñ NANO-V√çRUS</b><small>M√°quina fora de controle</small></div>
        <div class="opt-box" onclick="setVar('type', 'Bio-Arma', this)"><b>‚ò¢Ô∏è BIO-ARMA</b><small>Criado para matar</small></div>
      </div>
      <div id="errorType" class="error-msg-box"></div>
      <button class="btn-main" onclick="runNextStep(this, 'setupDiff', 'type', 'errorType', 'Voc√™ precisa selecionar um agente para avan√ßar')">Confirmar Agente</button>
    </div>

    <div id="setupDiff" class="glass setup-card">
      <h2 style="color: var(--gold); font-family: Orbitron; margin-bottom: 15px; font-size: 2.2rem;">N√çVEL DE RESPOSTA</h2>
      <div class="grid-select">
        <div class="opt-box" onclick="setVar('diff', 'Casual', this)"><b style="color: var(--green);">üü¢ CASUAL</b><small>Mundo descuidado.<br>M√©dicos de meio per√≠odo.</small></div>
        <div class="opt-box" onclick="setVar('diff', 'Normal', this)"><b style="color: var(--gold);">üü° NORMAL</b><small>Mundo reativo.<br>Higiene mediana.</small></div>
        <div class="opt-box" onclick="setVar('diff', 'Brutal', this)"><b style="color: var(--red);">üî¥ BRUTAL</b><small>Mundo em alerta.<br>Pesquisa agressiva.</small></div>
      </div>
      <div id="errorDiff" class="error-msg-box"></div>
      <button class="btn-main" onclick="runNextStep(this, 'setupName', 'diff', 'errorDiff', 'Voc√™ precisa selecionar um n√≠vel de resposta para avan√ßar')">Confirmar Resposta</button>
    </div>

    <div id="setupName" class="glass setup-card">
      <h2 style="color: var(--blue); font-family: Orbitron; font-size: 2.2rem;">NOMEIE SUA CRIA√á√ÉO</h2>
      <p style="color: #AAA; margin-bottom: 10px;">Identifique o agente do fim da humanidade.</p>
      <input type="text" id="nameIn" placeholder="NOME..." maxlength="18">
      <div id="errorName" class="error-msg-box"></div>
      <button class="btn-main" onclick="startGame()">INICIAR ANIQUILA√á√ÉO</button>
    </div>
  </div>

  <div id="mainGame">
    <div id="map"></div>

    <div class="bottom-hud">
      <div class="hud-panel" style="grid-template-columns: 1fr 1fr; gap: 10px 30px;">
        <div class="stat-item"><span class="stat-label">INFECTADOS</span><span class="stat-value infected" id="valInfected">0</span></div>
        <div class="stat-item"><span class="stat-label">CURADOS</span><span class="stat-value" style="color:var(--green)" id="valCured">0</span></div>
        <div class="stat-item"><span class="stat-label">MORTOS</span><span class="stat-value" id="valDead">0</span></div>
        <div class="stat-item"><span class="stat-label">VACINADOS</span><span class="stat-value" style="color:var(--blue)" id="valVax">0</span></div>
      </div>

      <div class="world-btn-container"><button class="btn-main btn-world" id="btnWorld" onclick="handleWorldClick()">MUNDO</button></div>

      <div class="hud-panel right-align" style="grid-template-columns: 1fr;">
        <div class="stat-item"><span class="stat-label">MUTAGENICIDADE (DNA)</span><span class="stat-value" style="color: var(--blue);" id="valDNA">0</span></div>
        <div class="stat-item" style="margin-top: 10px;"><span class="stat-label">N√çVEL DE AMEA√áA</span><span class="stat-value" id="valThreat">M√çNIMO</span></div>
      </div>
    </div>
  </div>

  <div id="welcomeGameModal" class="overlay" style="background: rgba(0,0,0,0.5);">
    <div class="glass modal-card" style="max-width: 500px; min-height: 480px; display: flex; flex-direction: column; justify-content: space-between;">
      <button class="btn-x" id="btnWClose" onclick="closeModal()" disabled>‚úï</button>
      <div id="welcomePages" style="flex-grow: 1;">
        <div class="w-page active">
          <h2 style="color: var(--red); font-family: Orbitron; margin-bottom: 20px;">PROTOCOLO INICIADO</h2>
          <p style="font-size: 1.1rem; line-height: 1.6; color: #EEE;">Bem-vindo(a) ao jogo <b>Praga</b>!<br><br>Voc√™ √© um(a) cientista descontente com a humanidade e decide p√¥r fim √† sua exist√™ncia. Para isso, dever√° espalhar seu agente pelo mundo inteiro, at√© eliminar todos os seres humanos da Terra. Sua mente brilhante ser√° capaz de ‚Äúconsertar‚Äù o estado atual do mundo?</p>
        </div>
        <div class="w-page" style="display: none;">
          <h2 style="color: var(--red); font-family: Orbitron; margin-bottom: 20px;">OBJETIVO INICIAL</h2>
          <p style="font-size: 1.1rem; line-height: 1.6; color: #EEE;">Toque no pa√≠s que seu agente infectar√° primeiro!<br><br>Ao selecionar um pa√≠s, voc√™ poder√° ver suas informa√ß√µes no mesmo bot√£o <b>"MUNDO"</b>. Clique no oceano para voltar a ver os dados globais.</p>
        </div>
      </div>
      <div>
        <div class="welcome-nav">
          <button class="btn-nav-arrow" id="btnWPrev" onclick="navWelcome(-1)" disabled>‚Üê</button>
          <button class="btn-main" id="btnWOk" style="width: auto; padding: 10px 30px;" onclick="closeModal()" disabled>OK</button>
          <button class="btn-nav-arrow" id="btnWNext" onclick="navWelcome(1)">‚Üí</button>
        </div>
        <div id="wPageIndicator">1/2</div>
      </div>
    </div>
  </div>

  <div id="dispersedModal" class="overlay" style="background: rgba(0,0,0,0.5);">
    <div class="glass modal-card" style="max-width: 500px;">
      <h2 style="color: var(--red); font-family: Orbitron; margin-bottom: 20px;">AGENTE DISPERSADO</h2>
      <p id="dispersedText" style="font-size: 1.1rem; line-height: 1.6; color: #EEE;"></p>
      <div style="text-align: center; margin-top: 30px;">
        <button class="btn-main" style="width: auto; padding: 10px 30px;" onclick="closeModal()">ENTENDIDO</button>
      </div>
    </div>
  </div>

  <div id="tutorialModal" class="overlay">
    <div class="glass modal-card">
      <button class="btn-x" onclick="closeModal()">‚úï</button>
      <h2 style="color: var(--blue); font-family: Orbitron; margin-bottom: 25px; letter-spacing: 2px;">MANUAL T√ÅTICO</h2>
      <div style="text-align: left; line-height: 1.8; color: #FFF; font-size: 1.15rem;">
        <p>‚Ä¢ <b>1. Inser√ß√£o:</b> Clique em um pa√≠s no mapa global para liberar o Agente Patog√™nico.</p>
        <p>‚Ä¢ <b>2. Recurso Gen√©tico:</b> Acumule 1 ponto de Mutagenicidade a cada <b>100.000</b> novos infectados.</p>
        <p>‚Ä¢ <b>3. Resposta Global:</b> A <b>Cura</b> foca nos infectados; a <b>Vacina</b> protege os saud√°veis.</p>
        <p>‚Ä¢ <b>4. Adapta√ß√£o:</b> Evoluir a praga for√ßa cientistas a reiniciar pesquisas, <b>atrasando cura e vacina</b>.</p>
      </div>
    </div>
  </div>

  <div id="newsLogModal" class="overlay">
    <div class="glass modal-card">
      <button class="btn-x" onclick="closeModal()">‚úï</button>
      <h2 style="color: var(--blue); font-family: Orbitron; margin-bottom: 25px;">HIST√ìRICO DE MANCHETES</h2>
      <div id="newsEntries" style="max-height: 400px; overflow-y: auto;"></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    /* =========================
       ESTADO GLOBAL
    ========================== */
    let game = {
      started: false, name: '', type: '', diff: '', active: false, newsLog: [], soundOn: false,

      // HUD globais
      infected: 0, dead: 0, cured: 0, vax: 0, dna: 0,
      popCap: 8200000000,
      lastDNAMilestone: 0,

      // Sele√ß√£o / dispers√£o
      selectedCountry: null,
      infectionStarted: false,
      patientZeroCountry: null,

      // Motor / tempo (melhoria)
      tickHandle: null,
      simDay: 0,            // dia simulado (float)
      dayInt: 0,            // dia inteiro (para eventos pontuais)
      lastRealTs: null,     // timestamp real do √∫ltimo tick
      time: {
        tickMs: 250,        // tick real (ms) -> mais suave, sem ‚Äúpulos‚Äù
        daysPerSecond: 0.20 // 0.20 = 1 dia a cada 5s (ajuste aqui se quiser mais lento/r√°pido)
      },

      // Pa√≠ses (simula√ß√£o)
      countries: {} // { [name]: { pop, infected, dead, cured, vax, hubs:{airport,port}, seededLandTo:Set, firstInfectedDay, lastMilestoneDNA, growthCarry } }
    };

    /* =========================
       HUBS (AEROPORTOS/PORTOS)
    ========================== */
    const worldHubs = [
      { country: "Brasil", type: "airport", city: "Bras√≠lia", lat: -15.8697, lng: -47.9208 },
      { country: "Brasil", type: "port", city: "Salvador", lat: -12.9228, lng: -38.5122 },

      { country: "M√©xico", type: "airport", city: "Cidade do M√©xico", lat: 19.4326, lng: -99.1332 },
      { country: "M√©xico", type: "port", city: "Veracruz", lat: 19.1738, lng: -96.1342 },

      { country: "Canad√°", type: "airport", city: "Ottawa", lat: 45.4215, lng: -75.6972 },
      { country: "Canad√°", type: "port", city: "Vancouver", lat: 49.2827, lng: -123.1207 },

      { country: "Argentina", type: "airport", city: "Buenos Aires", lat: -34.6037, lng: -58.3816 },
      { country: "Argentina", type: "port", city: "Mar del Plata", lat: -38.0055, lng: -57.5426 },

      { country: "Peru", type: "airport", city: "Lima", lat: -12.0464, lng: -77.0428 },
      { country: "Peru", type: "port", city: "Callao", lat: -12.0566, lng: -77.1491 },

      { country: "Col√¥mbia", type: "airport", city: "Bogot√°", lat: 4.7110, lng: -74.0721 },
      { country: "Col√¥mbia", type: "port", city: "Cartagena", lat: 10.3910, lng: -75.4794 },

      { country: "√Åfrica do Sul", type: "airport", city: "Joanesburgo", lat: -26.1367, lng: 28.2411 },
      { country: "√Åfrica do Sul", type: "port", city: "Cidade do Cabo", lat: -33.9189, lng: 18.4233 },

      { country: "Marrocos", type: "airport", city: "Rabat", lat: 33.9716, lng: -6.8498 },
      { country: "Marrocos", type: "port", city: "Casablanca", lat: 33.5731, lng: -7.5898 },

      { country: "Egito", type: "airport", city: "Cairo", lat: 30.1219, lng: 31.4056 },
      { country: "Egito", type: "port", city: "Alexandria", lat: 31.2001, lng: 29.9187 },

      { country: "Espanha", type: "airport", city: "Madrid", lat: 40.4839, lng: -3.5680 },
      { country: "Espanha", type: "port", city: "Barcelona", lat: 41.3851, lng: 2.1734 },

      { country: "Fran√ßa", type: "airport", city: "Paris", lat: 49.0097, lng: 2.5479 },
      { country: "Fran√ßa", type: "port", city: "Marselha", lat: 43.2965, lng: 5.3698 },

      { country: "Ar√°bia Saudita", type: "airport", city: "Riad", lat: 24.9576, lng: 46.6988 },
      { country: "Ar√°bia Saudita", type: "port", city: "Jid√°", lat: 21.4858, lng: 39.1925 },

      { country: "√çndia", type: "airport", city: "Nova Deli", lat: 28.5562, lng: 77.1000 },
      { country: "√çndia", type: "port", city: "Bombaim", lat: 18.9220, lng: 72.8347 },

      { country: "Finl√¢ndia", type: "airport", city: "Hels√≠nquia", lat: 60.3172, lng: 24.9633 },
      { country: "Finl√¢ndia", type: "port", city: "Hels√≠nquia", lat: 60.1600, lng: 24.9600 },

      { country: "Jap√£o", type: "airport", city: "T√≥quio", lat: 35.5494, lng: 139.7798 },
      { country: "Jap√£o", type: "port", city: "Yokohama", lat: 35.4437, lng: 139.6380 },

      { country: "Austr√°lia", type: "airport", city: "Canberra", lat: -35.3050, lng: 149.1934 },
      { country: "Austr√°lia", type: "port", city: "Sydney", lat: -33.8688, lng: 151.2093 },

      { country: "Nova Zel√¢ndia", type: "airport", city: "Wellington", lat: -41.3276, lng: 174.8076 },
      { country: "Nova Zel√¢ndia", type: "port", city: "Auckland", lat: -36.8485, lng: 174.7633 },

      { country: "Turquia", type: "airport", city: "Ancara", lat: 40.1281, lng: 32.9951 },
      { country: "Turquia", type: "port", city: "Istambul", lat: 41.0082, lng: 28.9784 },

      { country: "Reino Unido", type: "airport", city: "Londres", lat: 51.4700, lng: -0.4543 },

      { country: "R√∫ssia", type: "airport", city: "Moscou", lat: 55.7558, lng: 37.6173 },

      { country: "EUA", type: "airport", city: "Washington", lat: 38.8512, lng: -77.0402 },

      { country: "Groenl√¢ndia", type: "port", city: "Nuuk", lat: 64.1750, lng: -51.7389 },
      { country: "Madagascar", type: "port", city: "Toamasina", lat: -18.1492, lng: 49.4023 },

      { country: "Su√≠√ßa", type: "airport", city: "Berna", lat: 46.9128, lng: 7.4984 }
    ];

    /* =========================
       ADJAC√äNCIAS TERRESTRES (DEMO)
    ========================== */
    const LAND_NEIGHBORS = {
      "Brasil": ["Argentina", "Peru", "Col√¥mbia"],
      "Argentina": ["Brasil"],
      "Peru": ["Brasil", "Col√¥mbia"],
      "Col√¥mbia": ["Peru", "Brasil"],

      "M√©xico": ["EUA"],
      "Canad√°": ["EUA"],
      "EUA": ["Canad√°", "M√©xico"],

      "Fran√ßa": ["Espanha", "Su√≠√ßa"],
      "Espanha": ["Fran√ßa"],
      "Su√≠√ßa": ["Fran√ßa"],

      "R√∫ssia": ["Finl√¢ndia"],
      "Finl√¢ndia": ["R√∫ssia"],

      "√Åfrica do Sul": [],
      "Marrocos": [],
      "Egito": [],
      "Ar√°bia Saudita": [],
      "√çndia": [],
      "Jap√£o": [],
      "Austr√°lia": [],
      "Nova Zel√¢ndia": [],
      "Turquia": ["R√∫ssia"],
      "Reino Unido": [],
      "Groenl√¢ndia": [],
      "Madagascar": []
    };

    /* =========================
       POPULA√á√ïES (aprox. / balanceamento)
    ========================== */
    const POP_BY_COUNTRY = {
      "Brasil": 214000000,
      "Argentina": 46000000,
      "Peru": 34000000,
      "Col√¥mbia": 52000000,

      "M√©xico": 129000000,
      "Canad√°": 40000000,
      "EUA": 335000000,

      "Fran√ßa": 68000000,
      "Espanha": 48000000,
      "Su√≠√ßa": 9000000,

      "R√∫ssia": 144000000,
      "Finl√¢ndia": 5600000,
      "Turquia": 86000000,
      "Reino Unido": 68000000,

      "√Åfrica do Sul": 61000000,
      "Marrocos": 37000000,
      "Egito": 112000000,
      "Ar√°bia Saudita": 36000000,
      "√çndia": 1430000000,
      "Jap√£o": 124000000,
      "Austr√°lia": 26000000,
      "Nova Zel√¢ndia": 5200000,
      "Groenl√¢ndia": 56000,
      "Madagascar": 30000000
    };

    /* =========================
       √ÅUDIO (preservado)
    ========================== */
    const audioSystem = {
      tracks: [document.getElementById('bgMusic1'), document.getElementById('bgMusic2')],
      currentTrackIndex: 0,
      isMuted: true,

      init() {
        this.tracks.forEach(t => t.volume = 0);
        this.tracks[0].addEventListener('ended', () => this.crossfadeTo(1));
        this.tracks[1].addEventListener('ended', () => this.crossfadeTo(0));
      },
      crossfadeTo(nextIndex) {
        this.tracks[this.currentTrackIndex].pause();
        this.tracks[this.currentTrackIndex].currentTime = 0;
        this.currentTrackIndex = nextIndex;
        if (!this.isMuted) this.fadeIn(this.currentTrackIndex, 300);
      },
      fadeIn(index, duration = 300) {
        const track = this.tracks[index];
        track.play();
        let vol = 0;
        const steps = 10;
        const interval = duration / steps;
        const fInt = setInterval(() => {
          vol = Math.min(1, vol + 0.1);
          track.volume = vol;
          if (vol >= 1) clearInterval(fInt);
        }, interval);
      },
      toggleMute() {
        this.isMuted = !this.isMuted;
        if (this.isMuted) {
          this.tracks.forEach(t => { t.volume = 0; t.pause(); });
        } else {
          this.fadeIn(this.currentTrackIndex, 300);
        }
        return this.isMuted;
      }
    };
    audioSystem.init();

    function toggleSoundManual() {
      const muted = audioSystem.toggleMute();
      document.getElementById('soundBtnIcon').innerHTML = muted ?
        '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51c.66-1.24 1.03-2.65 1.03-4.15 0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/></svg>' :
        '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>';
    }

    /* =========================
       WELCOME MODAL (preservado)
    ========================== */
    let welcomePageIndex = 0;
    function navWelcome(dir) {
      const pages = document.querySelectorAll('.w-page');
      const indicator = document.getElementById('wPageIndicator');
      pages[welcomePageIndex].style.display = 'none';
      welcomePageIndex += dir;
      pages[welcomePageIndex].style.display = 'block';
      document.getElementById('btnWPrev').disabled = (welcomePageIndex === 0);
      document.getElementById('btnWNext').disabled = (welcomePageIndex === pages.length - 1);
      indicator.innerText = `${welcomePageIndex + 1}/${pages.length}`;
      if (welcomePageIndex === pages.length - 1) {
        document.getElementById('btnWClose').disabled = false;
        document.getElementById('btnWOk').disabled = false;
      }
    }

    /* =========================
       NOT√çCIAS (preservado)
    ========================== */
    const preGameNewsSource = [
      "\"Cansamos de salvar um futuro que insiste em se destruir.\"",
      "\"Quando o fato vira opini√£o, a ci√™ncia vira ru√≠na.\"",
      "\"O descr√©dito √© o √°cido que corr√≥i as funda√ß√µes do amanh√£.\"",
      "\"A ci√™ncia n√£o vai cair. Ela vai simplesmente se calar.\"",
      "\"Onde a cren√ßa vence a prova, o cientista se torna um fantasma.\"",
      "\"N√£o h√° como curar um mundo que ama a pr√≥pria ferida.\"",
      "\"O laboratory est√° vazio porque a verdade se tornou indesejada.\"",
      "\"A raz√£o se retirou da sala. O colapso agora √© livre.\"",
      "\"N√£o somos mais guias, somos apenas testemunhas da queda.\""
    ];
    let newsQueue = [];
    let newsTimeout;

    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    function scheduleNextNews() {
      if (game.started) return;
      if (newsQueue.length === 0) {
        newsQueue = [...preGameNewsSource];
        shuffleArray(newsQueue);
      }
      registerNews(newsQueue.pop());
      const randomDelay = Math.floor(Math.random() * 10001) + 10000;
      newsTimeout = setTimeout(scheduleNextNews, 20000 + randomDelay);
    }

    window.onload = () => {
      registerNews("O descr√©dito √† ci√™ncia tem levado muitos cientistas a se manifestarem contra essa tend√™ncia. Ser√° que a ci√™ncia se revoltar√° em breve?");
      setTimeout(scheduleNextNews, 22000);
    };

    function registerNews(text) {
      if (game.started) game.newsLog.unshift({ date: "20 jan. 2026", message: text });
      const ticker = document.getElementById('ticker');
      ticker.innerText = text.toUpperCase();
      ticker.style.transition = 'none';
      ticker.style.right = '-110%';
      setTimeout(() => {
        ticker.style.transition = 'right 20s linear';
        ticker.style.right = '125%';
      }, 100);
    }

    function openNewsLog() {
      game.active = false;
      document.getElementById('newsEntries').innerHTML = game.newsLog
        .map(e => `<div style="padding:10px; border-bottom:1px solid #333"><b style="color:var(--blue)">${e.date}</b>: ${e.message}</div>`)
        .join('');
      openModal('newsLogModal');
    }

    /* =========================
       FLUXO MENUS (preservado)
    ========================== */
    function goToOptimization() {
      document.getElementById('startMenu').classList.remove('active');
      document.getElementById('optiScreen').classList.add('active');
    }

    function initSetup() {
      document.getElementById('optiScreen').classList.remove('active');
      document.getElementById('selectionFlow').classList.add('active');
    }

    function setVar(key, val, el) {
      game[key] = val;
      el.parentElement.querySelectorAll('.opt-box').forEach(i => i.classList.remove('selected'));
      el.classList.add('selected');
    }

    function runNextStep(btn, id, currentKey, errorDivId, message) {
      const errorDiv = document.getElementById(errorDivId);
      if (!game[currentKey]) {
        errorDiv.innerText = message;
        errorDiv.style.opacity = '1';
        setTimeout(() => errorDiv.style.opacity = '0', 3000);
        return;
      }
      btn.closest('.setup-card').classList.remove('active');
      document.getElementById(id).classList.add('active');
    }

    function startGame() {
      game.name = document.getElementById('nameIn').value.trim();
      const errorDiv = document.getElementById('errorName');
      if (!game.name) {
        errorDiv.innerText = "Voc√™ precisa nomear sua cria√ß√£o para avan√ßar";
        errorDiv.style.opacity = '1';
        setTimeout(() => errorDiv.style.opacity = '0', 3000);
        return;
      }

      game.started = true;
      clearTimeout(newsTimeout);

      document.getElementById('bgOverlay').style.opacity = '0';
      document.getElementById('selectionFlow').classList.remove('active');
      document.getElementById('mainGame').style.display = 'block';
      document.getElementById('unifiedTopBar').classList.replace('glass-bar', 'highlight-bar');

      const vMap = {
        'Bact√©ria': 'BACTERIANO',
        'V√≠rus': 'VIRAL',
        'Fungo': 'F√öNGICO',
        'Parasita': 'PARASIT√ÅRIO',
        'Pr√≠on': 'PRI√îNICO',
        'Nano-V√≠rus': 'NANOTECNOL√ìGICO',
        'Bio-Arma': 'BIOL√ìGICO'
      };
      registerNews(`SISTEMA DE ANIQUILA√á√ÉO BIO-T√ÅTICA ONLINE. VETOR ${vMap[game.type]} PRONTO. AGUARDANDO DISPERS√ÉO.`);

      setTimeout(() => {
        if (!map) initMap();
        map.invalidateSize();
        openModal('welcomeGameModal');
      }, 100);
    }

    /* =========================
       MAPA / SELE√á√ÉO / HUBS
    ========================== */
    let map;
    let blipMarker;
    const hubLayer = L.layerGroup();

    function initMap() {
      map = L.map('map', {
        center: [20, 0],
        zoom: 2.5,
        minZoom: 2.5,
        zoomControl: false,
        attributionControl: false,
        worldCopyJump: true
      });

      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { noWrap: false }).addTo(map);

      hubLayer.addTo(map);
      renderHubs();

      map.on('zoomend', () => {
        if (map.getZoom() < 3) map.removeLayer(hubLayer);
        else hubLayer.addTo(map);
      });

      map.on('click', async (e) => {
        updateCountrySelection(e.latlng);
      });
    }

    function renderHubs() {
      worldHubs.forEach(hub => {
        const iconPath = (hub.type === 'airport') ? 'plane.svg' : 'anchor.svg';
        const icon = L.divIcon({
          className: 'hub-icon',
          html: `<img src="${iconPath}" class="hub-icon-img" width="22" height="22">`,
          iconSize: [24, 24]
        });
        const marker = L.marker([hub.lat, hub.lng], { icon: icon }).addTo(hubLayer);

        marker.on('click', (e) => {
          L.DomEvent.stopPropagation(e);
          updateCountrySelection({ lat: hub.lat, lng: hub.lng });
        });
      });
    }

    /* =========================
       UTILIT√ÅRIOS PT-BR (preservado)
    ========================== */
    function getCountryArticle(name) {
      const femCountries = ["Fran√ßa","Espanha","Argentina","Col√¥mbia","Ar√°bia Saudita","√çndia","Finl√¢ndia","Austr√°lia","Nova Zel√¢ndia","Turquia","R√∫ssia","Groenl√¢ndia","Madagascar","Su√≠√ßa","Bol√≠via","√Åfrica do Sul","Nig√©ria","It√°lia","Alemanha","Ucr√¢nia","China"];
      const pluralCountries = ["Estados Unidos", "EUA", "Filipinas", "Bahamas", "Maldivas", "Pa√≠ses Baixos"];
      if (pluralCountries.includes(name)) return "nos";
      return femCountries.includes(name) ? "na" : "no";
    }

    function getCountryAdjective(name) {
      const map = {
        "Brasil": "brasileiro","M√©xico": "mexicano","Canad√°": "canadense","Argentina": "argentino","Peru": "peruano","Col√¥mbia": "colombiano",
        "√Åfrica do Sul": "sul-africano","Marrocos": "marroquino","Egito": "eg√≠pcio","Espanha": "espanhol","Fran√ßa": "franc√™s","Ar√°bia Saudita": "saudita",
        "√çndia": "indiano","Finl√¢ndia": "finland√™s","Jap√£o": "japon√™s","Austr√°lia": "australiano","Nova Zel√¢ndia": "neozeland√™s","Turquia": "turco",
        "Reino Unido": "brit√¢nico","R√∫ssia": "russo","Estados Unidos": "estadunidense","EUA": "estadunidense","Groenl√¢ndia": "groenland√™s","Madagascar": "malgaxe","Su√≠√ßa": "su√≠√ßo"
      };
      return map[name] || "local";
    }

    /* =========================
       MOTOR DE PROPAGA√á√ÉO (MELHORIAS)
       - Tempo cont√≠nuo (simDay float) + ticks curtos
       - Crescimento log√≠stico com "carry" fracion√°rio -> in√≠cio pode ficar dias com 1 infectado
       - Probabilidades ar/mar convertidas para "por dia" e integradas por dtDays
       - Vazamento terrestre determin√≠stico ao atingir fra√ß√£o (com seed m√≠nimo)
    ========================== */

    function clamp(v, a, b) { return Math.max(a, Math.min(b, v)); }

    function ensureCountry(name) {
      if (!name) return null;

      if (!game.countries[name]) {
        const hasAirport = worldHubs.some(h => h.country === name && h.type === 'airport');
        const hasPort = worldHubs.some(h => h.country === name && h.type === 'port');

        game.countries[name] = {
          name,
          pop: POP_BY_COUNTRY[name] || 50000000,
          infected: 0,
          dead: 0,
          cured: 0,
          vax: 0,
          hubs: { airport: hasAirport, port: hasPort },
          seededLandTo: new Set(),
          firstInfectedDay: null,
          lastMilestoneDNA: 0,

          // melhoria-chave: acumula crescimento fracion√°rio (permite dias ‚Äúsem nada acontecer‚Äù)
          growthCarry: 0
        };
      }
      return game.countries[name];
    }

    function getDifficultyParams() {
      // Valores ‚Äúpor dia‚Äù (n√£o por tick). Ajuste fino aqui.
      const diff = game.diff;

      // growth: taxa base log√≠stica di√°ria
      // landThreshold: fra√ß√£o para vazamento terrestre
      // airBase/seaBase: chance base di√°ria (background) antes de converter para dtDays
      if (diff === "Casual") return { growth: 0.18, landThreshold: 0.22, airBase: 0.00035, seaBase: 0.00022 };
      if (diff === "Brutal") return { growth: 0.12, landThreshold: 0.28, airBase: 0.00020, seaBase: 0.00012 };
      return { growth: 0.145, landThreshold: 0.25, airBase: 0.00027, seaBase: 0.00016 }; // Normal
    }

    function getAgentParams() {
      const t = game.type;
      if (t === "V√≠rus") return { growthMul: 1.10, airMul: 1.12, seaMul: 0.95, landMul: 1.00 };
      if (t === "Bact√©ria") return { growthMul: 1.00, airMul: 1.00, seaMul: 1.00, landMul: 1.00 };
      if (t === "Fungo") return { growthMul: 0.90, airMul: 0.85, seaMul: 0.95, landMul: 0.90 };
      if (t === "Parasita") return { growthMul: 0.86, airMul: 0.80, seaMul: 0.85, landMul: 1.05 };
      if (t === "Pr√≠on") return { growthMul: 0.70, airMul: 0.65, seaMul: 0.65, landMul: 0.85 };
      if (t === "Nano-V√≠rus") return { growthMul: 1.06, airMul: 1.18, seaMul: 1.05, landMul: 1.00 };
      if (t === "Bio-Arma") return { growthMul: 1.12, airMul: 1.05, seaMul: 1.05, landMul: 1.00 };
      return { growthMul: 1.00, airMul: 1.00, seaMul: 1.00, landMul: 1.00 };
    }

    function logisticExpectedDeltaPerDay(I, P, r) {
      // dI = r*I*(1 - I/P) por dia (expectativa)
      if (I <= 0) return 0;
      const frac = I / P;
      const val = r * I * (1 - frac);
      return Math.max(0, val);
    }

    function seedInfection(countryName, amount, reason) {
      const c = ensureCountry(countryName);
      if (!c) return false;

      if (c.infected <= 0 && amount > 0) {
        c.firstInfectedDay = (c.firstInfectedDay === null) ? Math.floor(game.simDay) : c.firstInfectedDay;

        // DNA por pa√≠s novo (feedback)
        game.dna += 1;
        registerNews(`VETOR CONFIRMADO ${getCountryArticle(countryName).toUpperCase()} ${countryName.toUpperCase()}. PROPAGA√á√ÉO ${reason.toUpperCase()} DETECTADA.`);
      }

      c.infected = Math.min(c.pop, c.infected + amount);
      return true;
    }

    function landSpread(country, landThreshold, landMul) {
      const neighbors = LAND_NEIGHBORS[country.name] || [];
      if (neighbors.length === 0) return;

      const frac = country.infected / country.pop;

      // determin√≠stico: ao ‚Äúamadurecer‚Äù
      if (frac >= landThreshold) {
        neighbors.forEach(n => {
          if (country.seededLandTo.has(n)) return;

          // seed m√≠nimo controlado, cresce com a fra√ß√£o acima do threshold
          const excess = Math.max(0, frac - landThreshold);
          const seedAmt = Math.max(1, Math.floor(1 + 12 * excess * landMul));

          seedInfection(n, seedAmt, "terrestre");
          country.seededLandTo.add(n);
        });
      }
    }

    function pickRandom(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }

    function probDayToProbDt(pDay, dtDays) {
      // converte probabilidade "por dia" para probabilidade no intervalo dtDays
      // 1 - (1-p)^dt
      pDay = clamp(pDay, 0, 1);
      dtDays = Math.max(0, dtDays);
      return 1 - Math.pow(1 - pDay, dtDays);
    }

    function backgroundTravelSpread(country, params, agent, dtDays) {
      // Micro-aleatoriedade controlada (background transmission)
      const frac = country.infected / country.pop;
      if (frac <= 0) return;

      const hubsCount = worldHubs.filter(h => h.country === country.name).length;
      const trafficFactor = Math.min(2.0, 1.0 + (hubsCount * 0.35)); // 1.0 a 2.0

      const allCountries = Object.keys(game.countries);
      if (allCountries.length === 0) return;

      const airportDests = allCountries.filter(n => ensureCountry(n).hubs.airport && n !== country.name);
      const portDests = allCountries.filter(n => ensureCountry(n).hubs.port && n !== country.name);

      // pDay cresce um pouco com frac, mas satura (in√≠cio: muito baixo)
      const airPday = params.airBase * agent.airMul * trafficFactor * clamp(frac * 1.8, 0, 1);
      const seaPday = params.seaBase * agent.seaMul * trafficFactor * clamp(frac * 1.4, 0, 1);

      const pAir = probDayToProbDt(airPday, dtDays);
      const pSea = probDayToProbDt(seaPday, dtDays);

      if (country.hubs.airport && airportDests.length > 0) {
        if (Math.random() < pAir) {
          const dest = pickRandom(airportDests);
          seedInfection(dest, 1, "a√©rea");
        }
      }

      if (country.hubs.port && portDests.length > 0) {
        if (Math.random() < pSea) {
          const dest = pickRandom(portDests);
          seedInfection(dest, 1, "mar√≠tima");
        }
      }
    }

    function updateGlobalTotalsAndDNA() {
      let infected = 0, dead = 0, cured = 0, vax = 0;

      Object.values(game.countries).forEach(c => {
        infected += c.infected;
        dead += c.dead;
        cured += c.cured;
        vax += c.vax;
      });

      game.infected = infected;
      game.dead = dead;
      game.cured = cured;
      game.vax = vax;

      // DNA por marcos globais: 1 a cada 100.000
      const milestone = Math.floor(game.infected / 100000);
      if (milestone > game.lastDNAMilestone) {
        game.dna += (milestone - game.lastDNAMilestone);
        game.lastDNAMilestone = milestone;
      }
    }

    function calcThreat() {
      const ratio = game.infected / game.popCap;
      if (ratio < 0.00001) return "M√çNIMO";
      if (ratio < 0.0001) return "BAIXO";
      if (ratio < 0.001) return "MODERADO";
      if (ratio < 0.01) return "ALTO";
      return "CR√çTICO";
    }

    function updateHUD() {
      document.getElementById('valInfected').innerText = game.infected.toLocaleString('pt-BR');
      document.getElementById('valCured').innerText = game.cured.toLocaleString('pt-BR');
      document.getElementById('valDead').innerText = game.dead.toLocaleString('pt-BR');
      document.getElementById('valVax').innerText = game.vax.toLocaleString('pt-BR');
      document.getElementById('valDNA').innerText = game.dna.toLocaleString('pt-BR');
      document.getElementById('valThreat').innerText = calcThreat();
    }

    function simulateStep(dtDays) {
      if (!game.infectionStarted) return;

      const params = getDifficultyParams();
      const agent = getAgentParams();

      // 1) Crescimento intra-pa√≠s com carry fracion√°rio
      Object.values(game.countries).forEach(c => {
        if (c.infected <= 0) return;

        const baseGrowthPerDay = params.growth * agent.growthMul;

        // expectativa di√°ria -> escala por dtDays
        const expected = logisticExpectedDeltaPerDay(c.infected, c.pop, baseGrowthPerDay) * dtDays;

        // acumula fra√ß√£o (isso cria "dias parados" com 1 infectado, e depois sobe)
        c.growthCarry += expected;

        // limita carry para evitar explos√µes por lag/aba inativa
        c.growthCarry = Math.min(c.growthCarry, c.pop);

        const deltaInt = Math.floor(c.growthCarry);
        if (deltaInt > 0) {
          c.growthCarry -= deltaInt;
          c.infected = Math.min(c.pop, c.infected + deltaInt);
        }

        // 2) Vazamento terrestre (determin√≠stico por estado, n√£o por sorte)
        landSpread(c, params.landThreshold, agent.landMul);

        // 3) Ar/mar (micro-aleatoriedade) usando prob convertida por dtDays
        backgroundTravelSpread(c, params, agent, dtDays);
      });

      updateGlobalTotalsAndDNA();
      updateHUD();
    }

    function gameTick() {
      if (!game.infectionStarted) return;

      const now = performance.now();
      if (game.lastRealTs === null) game.lastRealTs = now;

      // dt real em segundos (clamp para estabilidade)
      let dtSec = (now - game.lastRealTs) / 1000;
      game.lastRealTs = now;
      dtSec = clamp(dtSec, 0, 0.5); // evita explos√µes se travar

      // avan√ßa tempo simulado
      const dtDays = dtSec * game.time.daysPerSecond;
      game.simDay += dtDays;

      // dispara eventos por "dia inteiro" quando cruzar o pr√≥ximo inteiro
      const newDayInt = Math.floor(game.simDay);
      if (newDayInt > game.dayInt) {
        const crossed = newDayInt - game.dayInt;
        game.dayInt = newDayInt;

        // not√≠cia pontual (sem spam)
        if (game.dayInt === 5) {
          registerNews("OBSERVA√á√ÉO: NO IN√çCIO, A PROPAGA√á√ÉO GLOBAL √â BAIXA. O FOCO PRIM√ÅRIO √â A CONSOLIDA√á√ÉO LOCAL.");
        }

        // voc√™ pode colocar aqui eventos que acontecem "por dia" (cura/vacina etc.)
        // crossed indica quantos dias inteiros passaram desde o √∫ltimo tick
      }

      // simula a din√¢mica para o dtDays do tick
      simulateStep(dtDays);
    }

    function startTickLoop() {
      if (game.tickHandle) clearInterval(game.tickHandle);
      game.lastRealTs = null;
      game.tickHandle = setInterval(gameTick, game.time.tickMs);
    }

    /* =========================
       SELE√á√ÉO DE PA√çS / DISPERS√ÉO
    ========================== */
    async function updateCountrySelection(latlng) {
      const url = `https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${latlng.lat}&longitude=${latlng.lng}&localityLanguage=pt`;
      const res = await fetch(url);
      const data = await res.json();

      const btn = document.getElementById('btnWorld');

      if (data.countryName) {
        game.selectedCountry = data.countryName;
        btn.innerText = data.countryName.toUpperCase();

        if (blipMarker) map.removeLayer(blipMarker);
        const blipIcon = L.divIcon({ className: 'bio-blip', iconSize: [15, 15] });
        blipMarker = L.marker(latlng, { icon: blipIcon }).addTo(map);

        ensureCountry(data.countryName);

        if (!game.infectionStarted) {
          const article = getCountryArticle(data.countryName);
          const popupContent = `
            <div class="dispersal-box">
              <p>Deseja iniciar a dispers√£o do agente ${article} <b>${data.countryName}</b>?</p>
              <div class="dispersal-actions">
                <button class="btn-mini" onclick="confirmInfection()">SIM</button>
                <button class="btn-mini" onclick="map.closePopup()">N√ÉO</button>
              </div>
            </div>
          `;
          L.popup({ closeButton: false, offset: [0, -10] })
            .setLatLng(latlng)
            .setContent(popupContent)
            .openOn(map);
        }
      } else {
        game.selectedCountry = null;
        btn.innerText = "MUNDO";
        if (blipMarker) map.removeLayer(blipMarker);
        map.closePopup();
      }
    }

    function confirmInfection() {
      if (!game.selectedCountry) return;

      game.infectionStarted = true;
      game.patientZeroCountry = game.selectedCountry;

      // reset tempo (para ficar consistente)
      game.simDay = 0;
      game.dayInt = 0;
      game.lastRealTs = null;

      ensureCountry(game.patientZeroCountry);

      // Paciente Zero determin√≠stico: exatamente 1 infectado
      seedInfection(game.patientZeroCountry, 1, "inicial");

      // DNA inicial
      game.dna = Math.max(1, game.dna);

      updateGlobalTotalsAndDNA();
      updateHUD();

      map.closePopup();

      const adj = getCountryAdjective(game.patientZeroCountry);
      const msg =
        `O agente <b>${game.name}</b> foi liberado em solo <b>${adj}</b> e j√° contaminou sua primeira v√≠tima.<br><br>
         <b>Tempo e ritmo:</b> o rel√≥gio avan√ßa continuamente, mas o crescimento √© log√≠stico e pode permanecer lento no in√≠cio, com dias sem aumento vis√≠vel. Vazamentos terrestres s√≥ ocorrem quando o surto amadurece, enquanto rotas a√©reas e mar√≠timas t√™m chance <b>baix√≠ssima</b> no come√ßo (micro-aleatoriedade controlada).`;

      document.getElementById('dispersedText').innerHTML = msg;
      openModal('dispersedModal');

      registerNews(`SURTO INICIADO. PACIENTE ZERO IDENTIFICADO ${getCountryArticle(game.patientZeroCountry).toUpperCase()} ${game.patientZeroCountry.toUpperCase()}.`);

      // Inicializa o ‚Äúmundo t√°tico‚Äù
      const seedWorld = new Set(worldHubs.map(h => h.country));
      Object.keys(LAND_NEIGHBORS).forEach(k => seedWorld.add(k));
      seedWorld.forEach(cn => ensureCountry(cn));

      startTickLoop();
    }

    /* =========================
       WORLD BUTTON (preservado)
    ========================== */
    function handleWorldClick() {
      if (game.selectedCountry) {
        const c = ensureCountry(game.selectedCountry);
        const pct = c && c.pop ? ((c.infected / c.pop) * 100) : 0;
        alert(
          `RELAT√ìRIO T√ÅTICO ‚Äî ${game.selectedCountry}\n\n` +
          `Popula√ß√£o: ${c.pop.toLocaleString('pt-BR')}\n` +
          `Infectados: ${c.infected.toLocaleString('pt-BR')} (${pct.toFixed(4)}%)\n` +
          `Hubs: ${c.hubs.airport ? "‚úàÔ∏è" : "‚Äî"} ${c.hubs.port ? "‚öì" : "‚Äî"}\n\n` +
          `Dia (simulado): ${game.simDay.toFixed(2)}\n` +
          `Rotas terrestres mapeadas (demo): ${(LAND_NEIGHBORS[game.selectedCountry] || []).join(", ") || "‚Äî"}`
        );
      } else {
        alert('Estat√≠sticas globais em desenvolvimento.');
      }
    }

    /* =========================
       MODAIS (preservado)
    ========================== */
    function openModal(id) {
      document.getElementById(id).style.display = 'flex';
    }

    function closeModal() {
      document.querySelectorAll('.overlay').forEach(o => o.style.display = 'none');
      if (game.started) game.active = true;
    }
  </script>
</body>
</html>